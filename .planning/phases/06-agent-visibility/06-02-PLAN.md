---
phase: 06-agent-visibility
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/classes/agentList.class.js
  - src/assets/css/mod_agentList.css
autonomous: true

must_haves:
  truths:
    - "Agent names are 2-4 word descriptive phrases derived from task"
    - "Running agents display yellow pulsing indicator"
    - "Completed agents display green indicator"
    - "Each agent shows task description below name"
    - "Clicking agent row expands to show full description"
  artifacts:
    - path: "src/classes/agentList.class.js"
      provides: "Agent list widget with IPC subscription"
      contains: "window.addEventListener('claude-state-changed'"
    - path: "src/assets/css/mod_agentList.css"
      provides: "Status colors and animations"
      contains: "@keyframes pulse"
  key_links:
    - from: "src/classes/agentList.class.js"
      to: "window.claudeState.agents"
      via: "claude-state-changed event"
      pattern: "addEventListener\\('claude-state-changed'"
---

<objective>
Refactor AgentList widget to use IPC events and display AI-generated names with status indicators.

Purpose: Replace polling with event-driven updates; implement CONTEXT.md decisions for agent display.
Output: AgentList widget shows agents with descriptive names, status colors, and click-to-expand.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-visibility/06-CONTEXT.md
@.planning/phases/06-agent-visibility/06-01-SUMMARY.md

@src/classes/agentList.class.js
@src/assets/css/mod_agentList.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor AgentList to use IPC events</name>
  <files>src/classes/agentList.class.js</files>
  <action>
Refactor AgentList class to use `claude-state-changed` event pattern (like ContextWidget):

1. Remove existing polling:
   - Delete `setInterval(() => this.scanAgents(), 5000)` from `init()`
   - Delete `scanAgents()` method
   - Delete `scanSubagentsDir()` method

2. Add state subscription in constructor (after HTML setup):
```javascript
this._onStateChange = this._onStateChange.bind(this);
window.addEventListener('claude-state-changed', this._onStateChange);
```

3. Rename `init()` to setup initial render:
```javascript
init() {
    // Initial render with loading state
    this.contentEl.innerHTML = '<div class="loading">Waiting for agent data...</div>';

    // If state already exists, render immediately
    if (window.claudeState && window.claudeState.agents) {
        this._onStateChange({ detail: window.claudeState });
    }
}
```

4. Add `_onStateChange(event)` method:
```javascript
_onStateChange(event) {
    const state = event.detail;
    if (!state || !state.agents) return;

    // Filter and sort agents
    const agents = this._processAgents(state.agents);
    this.render(agents);
}
```

5. Add `_processAgents(agents)` method:
```javascript
_processAgents(agents) {
    // Filter: only show agents from last 24 hours that aren't OFFLINE
    const cutoff = Date.now() - (24 * 60 * 60 * 1000);
    const filtered = agents.filter(a => a.mtime > cutoff && a.status !== 'OFFLINE');

    // Sort by status priority (RUNNING first, then PENDING, then others) then by mtime
    const statusPriority = { 'RUNNING': 0, 'PENDING': 1, 'COMPLETE': 2, 'FAILED': 3 };
    filtered.sort((a, b) => {
        const priorityDiff = (statusPriority[a.status] || 99) - (statusPriority[b.status] || 99);
        if (priorityDiff !== 0) return priorityDiff;
        return b.mtime - a.mtime;
    });

    // Limit to 5 visible
    return filtered.slice(0, 5);
}
```

6. Add `_generateAgentName(task, slug)` method:
```javascript
_generateAgentName(task, slug) {
    // Prefer slug if available (Claude provides these)
    if (slug) {
        // Convert slug like "lively-percolating-cerf" to "Lively Percolating Cerf"
        return slug.split('-')
            .map(w => w.charAt(0).toUpperCase() + w.slice(1))
            .join(' ');
    }

    // Fallback: extract 2-4 words from task description
    if (!task || task === 'Unknown task') return 'Agent Task';

    const firstSentence = task.split(/[.!?\n]/)[0] || task;
    const cleaned = firstSentence.slice(0, 100).trim()
        .replace(/^(please |can you |could you |i need |let's |now )/i, '')
        .replace(/^(implement |create |fix |update |add |remove |change |modify )/i, '$1');

    const words = cleaned.split(/\s+/)
        .filter(w => w.length > 2)
        .slice(0, 4)
        .map(w => w.replace(/[^a-zA-Z0-9]/g, ''));

    const name = words
        .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
        .join(' ');

    // Max 30 chars with ellipsis
    if (name.length > 30) {
        return name.slice(0, 27) + '...';
    }

    return name || 'Agent Task';
}
```
  </action>
  <verify>
1. Start app with `npm start`
2. Open DevTools console
3. Verify no polling errors (no setInterval calls)
4. When `window.claudeState.agents` updates, agent list should re-render
5. Check agent names are descriptive (not raw IDs)
  </verify>
  <done>
- AgentList uses `claude-state-changed` event instead of polling
- Agents processed with status priority sorting
- Agent names generated from slug or task description
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement two-line layout with status indicators</name>
  <files>src/classes/agentList.class.js</files>
  <action>
Update render method to implement CONTEXT.md two-line layout with status indicators:

1. Update `render(agents)` method:
```javascript
render(agents) {
    if (agents.length === 0) {
        this.contentEl.innerHTML = '<div class="no-agents">- NO ACTIVE AGENTS -</div>';
        return;
    }

    let html = '';
    agents.forEach((agent, index) => {
        const name = this._generateAgentName(agent.task, agent.slug);
        const statusClass = agent.status.toLowerCase();
        const taskPreview = this._truncateTask(agent.task, 60);
        const fullTask = this._escapeHtml(agent.task || 'No task description');

        html += `
            <div class="agent-item ${statusClass}" data-agent-id="${agent.id}" data-expanded="false">
                <div class="agent-line1">
                    <span class="agent-status-dot ${statusClass}"></span>
                    <span class="agent-name">${this._escapeHtml(name)}</span>
                </div>
                <div class="agent-line2">
                    <span class="agent-task-preview">${this._escapeHtml(taskPreview)}</span>
                </div>
                <div class="agent-full-task" style="display: none;">
                    ${fullTask}
                </div>
            </div>
        `;
    });

    this.contentEl.innerHTML = html;

    // Add click handlers for expand/collapse
    this.contentEl.querySelectorAll('.agent-item').forEach(item => {
        item.addEventListener('click', () => this._toggleExpand(item));
    });
}
```

2. Add `_truncateTask(task, maxLen)` helper:
```javascript
_truncateTask(task, maxLen) {
    if (!task) return 'No task description';
    if (task.length <= maxLen) return task;
    return task.slice(0, maxLen - 3) + '...';
}
```

3. Add `_escapeHtml(text)` helper:
```javascript
_escapeHtml(text) {
    if (!text) return '';
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}
```

4. Add `_toggleExpand(item)` method:
```javascript
_toggleExpand(item) {
    const isExpanded = item.getAttribute('data-expanded') === 'true';
    const fullTask = item.querySelector('.agent-full-task');
    const preview = item.querySelector('.agent-task-preview');

    if (isExpanded) {
        fullTask.style.display = 'none';
        preview.style.display = '';
        item.setAttribute('data-expanded', 'false');
    } else {
        fullTask.style.display = 'block';
        preview.style.display = 'none';
        item.setAttribute('data-expanded', 'true');
    }
}
```
  </action>
  <verify>
1. Start app and check agent list renders with two lines per agent
2. Line 1: status dot + name
3. Line 2: truncated task description
4. Click on agent row to expand/collapse full description
5. Verify HTML is properly escaped (no XSS from task descriptions)
  </verify>
  <done>
- Two-line layout: name on line 1, task preview on line 2
- Click expands to show full task description
- HTML properly escaped for security
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CSS for status colors and animations</name>
  <files>src/assets/css/mod_agentList.css</files>
  <action>
Update mod_agentList.css to implement CONTEXT.md visual decisions:

1. Add pulsing animation:
```css
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}
```

2. Add status dot styles:
```css
.agent-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    flex-shrink: 0;
}

.agent-status-dot.pending {
    background-color: #888;
}

.agent-status-dot.running {
    background-color: #ff0;
    animation: pulse 1.5s ease-in-out infinite;
}

.agent-status-dot.complete {
    background-color: #0f0;
}

.agent-status-dot.failed {
    background-color: #f00;
}
```

3. Update agent-item with background tints:
```css
.agent-item {
    display: flex;
    flex-direction: column;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    transition: background-color 250ms ease;
}

.agent-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.agent-item.pending {
    background-color: rgba(128, 128, 128, 0.1);
}

.agent-item.running {
    background-color: rgba(255, 255, 0, 0.08);
}

.agent-item.complete {
    background-color: rgba(0, 255, 0, 0.08);
}

.agent-item.failed {
    background-color: rgba(255, 0, 0, 0.08);
}
```

4. Add two-line layout styles:
```css
.agent-line1 {
    display: flex;
    align-items: center;
}

.agent-name {
    font-size: 0.85em;
    color: var(--color_main);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.agent-line2 {
    margin-top: 3px;
    padding-left: 16px; /* Align with name after dot */
}

.agent-task-preview {
    font-size: 0.7em;
    color: var(--color_main);
    opacity: 0.6;
}

.agent-full-task {
    font-size: 0.7em;
    color: var(--color_main);
    opacity: 0.8;
    margin-top: 6px;
    padding: 6px 8px;
    padding-left: 16px;
    background-color: rgba(0, 0, 0, 0.2);
    border-left: 2px solid var(--color_main);
    white-space: pre-wrap;
    word-break: break-word;
}
```

5. Remove old status styles (cleanup):
- Remove `.agent-status` badge styles (replaced by dot)
- Remove `.agent-row` (replaced by `.agent-line1`)
- Remove `.agent-task` (replaced by `.agent-line2` / `.agent-task-preview`)

Keep existing:
- `#mod_agentList` container styles
- `#mod_agentList>h1` header styles
- `#mod_agentList_content` content area styles
- `.loading` and `.no-agents` states
  </action>
  <verify>
1. Start app and verify visual styling:
   - Running agents: yellow pulsing dot, subtle yellow background tint
   - Completed agents: green dot, subtle green background tint
   - Pending agents: gray dot, subtle gray background tint
   - Failed agents: red dot, subtle red background tint
2. Verify pulsing animation is smooth (1.5s cycle)
3. Verify hover state on agent items
4. Verify expanded task has proper formatting
  </verify>
  <done>
- Status dot colors: gray (pending), yellow (running), green (complete), red (failed)
- Running status has pulsing animation
- Background tints are subtle but distinguishable
- Expanded task area has readable formatting
  </done>
</task>

</tasks>

<verification>
Full integration test:
1. Start app with `npm start`
2. Open DevTools and verify no console errors
3. Verify agent list shows "NO ACTIVE AGENTS" initially (if no agents)
4. Run a Claude Code session that spawns agents
5. Verify:
   - Agents appear within 5 seconds
   - Names are descriptive (not raw IDs like "a72eb7b")
   - Running agents have yellow pulsing dot
   - Completed agents have green static dot
   - Each agent shows two lines (name + task preview)
   - Clicking expands to show full task
   - Status colors/tints are visually distinct
</verification>

<success_criteria>
- AGENT-01: Agent names are 2-4 word descriptive phrases (from slug or task extraction)
- AGENT-02: Running=yellow pulsing, Complete=green, Pending=gray, Failed=red
- AGENT-03: Each agent shows task description below name
- AGENT-04: Running agents have animated pulsing indicator
- Widget updates within 5 seconds of agent state change
- Click-to-expand functionality works
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-visibility/06-02-SUMMARY.md`
</output>
