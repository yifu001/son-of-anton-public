---
phase: 06-agent-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/classes/claudeState.class.js
autonomous: true

must_haves:
  truths:
    - "ClaudeStateManager watches subagent directories for changes"
    - "Agent data is included in IPC state updates"
    - "Agent status is derived from todo files or mtime fallback"
  artifacts:
    - path: "src/classes/claudeState.class.js"
      provides: "Agent scanning and state aggregation"
      contains: "this.state.agents"
      exports: ["ClaudeStateManager"]
  key_links:
    - from: "src/classes/claudeState.class.js"
      to: "~/.claude/projects/*/subagents/"
      via: "chokidar file watcher"
      pattern: "chokidar\\.watch.*subagents"
    - from: "src/classes/claudeState.class.js"
      to: "renderer via IPC"
      via: "claude-state-update channel"
      pattern: "send\\('claude-state-update'"
---

<objective>
Extend ClaudeStateManager to watch Claude Code subagent directories and include agent data in state updates.

Purpose: Enable real-time agent visibility by watching subagent files and aggregating status from todo files.
Output: ClaudeStateManager broadcasts agent data via existing IPC channel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-visibility/06-RESEARCH.md

@src/classes/claudeState.class.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subagent directory watching</name>
  <files>src/classes/claudeState.class.js</files>
  <action>
Extend ClaudeStateManager to watch subagent directories:

1. Add state property:
   - `this.state.agents = []` in constructor

2. Add subagent watcher in `start()` method:
   - Watch `~/.claude/projects/*/subagents/` using chokidar with glob pattern
   - Also watch `~/.claude/projects/*/*/subagents/` for session-scoped subagents
   - Use same watcherOptions as existing watchers (awaitWriteFinish: 500ms)
   - Handle 'add', 'change', 'unlink' events with `_handleSubagentChange(filepath)`

3. Add `_handleSubagentChange(filepath)` method:
   - Validate filepath is `agent-*.jsonl` file
   - Call `_scanAllAgents()` on any change (simpler than incremental updates)

4. Add `_scanAllAgents()` method:
   - Scan `~/.claude/projects/` directory
   - For each project, check `subagents/` and `*/subagents/` subdirectories
   - Filter to `agent-*.jsonl` files modified in last 24 hours
   - Parse first line of each file for task description and slug
   - Call `_getAgentStatus(sessionId, agentId, mtime)` for status
   - Deduplicate by agentId
   - Sort by mtime descending (most recent first)
   - Limit to 20 agents maximum (prevent memory growth)
   - Update `this.state.agents` and call `_sendUpdate()`

5. Add `_getAgentStatus(sessionId, agentId, mtime)` method:
   - Check for todo file at `~/.claude/todos/{sessionId}-agent-{agentId}.json`
   - If exists: parse and check status fields
     - Any `in_progress` -> return 'RUNNING'
     - All `completed` -> return 'COMPLETE'
     - Any `pending` -> return 'PENDING'
   - Fallback to mtime heuristic:
     - mtime < 10 seconds ago -> 'RUNNING'
     - mtime < 30 minutes ago -> 'PENDING'
     - else -> 'COMPLETE' (assume finished)

Agent object shape:
```javascript
{
  id: string,           // e.g., "a72eb7b"
  slug: string|null,    // e.g., "lively-percolating-cerf"
  task: string,         // First 200 chars of task description
  status: string,       // 'PENDING' | 'RUNNING' | 'COMPLETE' | 'FAILED'
  mtime: number,        // File modification timestamp
  sessionId: string|null // Parent session ID if available
}
```

Use synchronous fs operations (fs.existsSync, fs.readdirSync, fs.readFileSync) to match existing patterns in the class. Wrap in try/catch for graceful degradation.
  </action>
  <verify>
Manual verification:
1. Start the app with `npm start`
2. Open DevTools console and check `window.claudeState.agents` is an array
3. Run a Claude Code session that spawns subagents
4. Verify agents appear in `window.claudeState.agents` within 1 second
5. Check agent objects have correct shape (id, slug, task, status, mtime)
  </verify>
  <done>
- ClaudeStateManager watches `~/.claude/projects/*/subagents/` directories
- `this.state.agents` array contains agent data
- Agent status derived from todo files with mtime fallback
- State updates broadcast via existing IPC channel within 1 second of file change
  </done>
</task>

<task type="auto">
  <name>Task 2: Add polling fallback for subagents</name>
  <files>src/classes/claudeState.class.js</files>
  <action>
Add polling fallback for subagent scanning (similar to existing liveContext polling):

1. Add `_subagentPollInterval` property in constructor

2. In `start()` method, after subagent watcher setup:
   - Set `this._subagentPollInterval = setInterval(() => this._pollSubagents(), 5000)`
   - 5 seconds is sufficient (agents don't change as rapidly as context)

3. Add `_pollSubagents()` method:
   - Call `_scanAllAgents()` directly
   - This provides fallback when chokidar glob watching is unreliable on Windows

4. In `stop()` method:
   - Clear the interval: `if (this._subagentPollInterval) { clearInterval(this._subagentPollInterval); this._subagentPollInterval = null; }`

Why polling fallback: chokidar's glob watching can miss changes on Windows, especially with network drives or OneDrive-synced folders. The existing liveContext uses 2s polling for this reason.
  </action>
  <verify>
1. Start app and let it run for 15+ seconds
2. Check DevTools console for any errors related to subagent polling
3. Verify `window.claudeState.agents` updates even if no active Claude sessions
4. Stop and restart a Claude session to confirm agents list updates
  </verify>
  <done>
- 5-second polling interval provides reliable updates on Windows
- Interval properly cleaned up in `stop()` method
- No memory leaks from orphaned intervals
  </done>
</task>

</tasks>

<verification>
Run the app and verify:
1. No errors in console related to ClaudeStateManager
2. `window.claudeState.agents` is an array (possibly empty if no recent agents)
3. When Claude Code spawns an agent, it appears in the agents array within 5 seconds
4. Agent objects have: id, slug, task, status, mtime fields
5. Status values are one of: PENDING, RUNNING, COMPLETE, FAILED
</verification>

<success_criteria>
- ClaudeStateManager watches subagent directories via chokidar with 5s polling fallback
- Agent data included in `window.claudeState.agents` array
- Agent status correctly derived from todo files or mtime fallback
- State updates broadcast via existing `claude-state-update` IPC channel
- No errors or crashes when subagent directories don't exist
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-visibility/06-01-SUMMARY.md`
</output>
