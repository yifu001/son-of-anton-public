---
phase: 01-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/classes/netstat.class.js
autonomous: true

must_haves:
  truths:
    - "Network status widget shows ONLINE when Windows has internet connectivity"
    - "Network status widget displays correct IPv4 address"
    - "Network status widget displays ping latency to configured address"
    - "Interface name displays in widget header"
  artifacts:
    - path: "src/classes/netstat.class.js"
      provides: "Windows-compatible interface detection"
      contains: "Windows_NT"
  key_links:
    - from: "src/classes/netstat.class.js"
      to: "window.si.networkInterfaces()"
      via: "systeminformation API"
      pattern: "networkInterfaces"
---

<objective>
Fix Windows network interface detection in netstat.class.js

Purpose: The network status widget fails to detect valid interfaces on Windows because the detection loop requires `operstate === "up"`, but Windows often reports `operstate === "unknown"` for active interfaces. This causes the widget to show OFFLINE and blocks FIX-01 (globe shows mock data when netstat.offline is true).

Output: Modified netstat.class.js with Windows-compatible interface detection logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bug-fixes/01-RESEARCH.md
@src/classes/netstat.class.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Windows-compatible interface detection</name>
  <files>src/classes/netstat.class.js</files>
  <action>
Modify the interface detection logic in updateInfo() method (lines 88-108) to handle Windows properly.

Current problematic code (line 91):
```javascript
while (net.operstate !== "up" || net.internal === true || net.ip4 === "" || net.mac === "") {
```

This fails on Windows because:
1. Windows interfaces often have `operstate === "unknown"` even when functional
2. MAC address may be empty for some virtual adapters

Replace with platform-aware detection:

1. Add OS detection at top of the else block (after line 88):
```javascript
const isWindows = require("os").type() === "Windows_NT";
```

2. Replace the while loop condition with Windows-aware logic:
```javascript
// Windows: Accept "unknown" operstate and don't require MAC
// Other OS: Keep strict requirements
const isValidInterface = (iface) => {
    if (iface.internal === true) return false;
    if (iface.ip4 === "") return false;
    if (isWindows) {
        // Windows: operstate is often "unknown" for active interfaces
        return iface.operstate === "up" || iface.operstate === "unknown";
    } else {
        // Linux/Mac: require "up" and MAC address
        return iface.operstate === "up" && iface.mac !== "";
    }
};

while (!isValidInterface(net)) {
    if (window.settings.debug) console.log(`[Netstat] Skipping ${net.iface}: operstate=${net.operstate}, internal=${net.internal}, ip4=${net.ip4}, mac=${net.mac}`);
    netID++;
    if (data[netID]) {
        net = data[netID];
    } else {
        // No external connection!
        if (window.settings.debug) console.log("[Netstat] No valid interface found - going offline");
        // ... existing offline handling code ...
        break;
    }
}
```

3. Update debug logging to include OS type:
```javascript
if (window.settings.debug) console.log(`[Netstat] Platform: ${require("os").type()}, searching for valid interface...`);
```

Keep all existing functionality intact. Only modify the interface detection criteria.
  </action>
  <verify>
1. Code syntax valid: No errors when app loads
2. Debug output shows platform detection: Enable debug mode in settings.json, check console for "[Netstat] Platform: Windows_NT"
3. Interface selected: Check console for "[Netstat] Selected interface: {name}"
  </verify>
  <done>
- Interface detection loop accepts `operstate === "unknown"` on Windows
- Valid interface with IPv4 address is selected
- Debug logging shows Windows-specific path taken
  </done>
</task>

<task type="auto">
  <name>Task 2: Add interface prioritization by IPv4</name>
  <files>src/classes/netstat.class.js</files>
  <action>
Add smarter interface selection that prioritizes interfaces with valid private IPv4 addresses over public/unusual ones.

After the isValidInterface function, before the while loop, add prioritization:

```javascript
// Prioritize interfaces: prefer those with typical private IP ranges
const prioritizeInterfaces = (interfaces) => {
    return interfaces.slice().sort((a, b) => {
        const scoreIface = (iface) => {
            if (!iface.ip4) return 0;
            // Prefer common private ranges
            if (iface.ip4.startsWith("192.168.")) return 100;
            if (iface.ip4.startsWith("10.")) return 90;
            if (iface.ip4.match(/^172\.(1[6-9]|2[0-9]|3[01])\./)) return 80;
            // Valid non-private IP
            if (iface.ip4 !== "127.0.0.1") return 50;
            return 0;
        };
        return scoreIface(b) - scoreIface(a);
    });
};

// Apply prioritization on Windows (where multiple valid interfaces common)
if (isWindows) {
    data = prioritizeInterfaces(data);
    net = data[0];
    netID = 0;
}
```

This ensures that on Windows systems with multiple interfaces (Ethernet, WiFi, VPN, Hyper-V, WSL), the most likely "real" network interface is selected first.
  </action>
  <verify>
1. On multi-interface Windows system, primary network interface selected
2. Interface with 192.168.x.x or 10.x.x.x preferred over virtual adapters
3. Existing Linux/Mac behavior unchanged
  </verify>
  <done>
- Windows prioritizes private IP ranges (192.168.x, 10.x, 172.16-31.x)
- Virtual adapters (usually with unusual IPs) deprioritized
- Non-Windows platforms use original detection order
  </done>
</task>

<task type="auto">
  <name>Task 3: Test network status widget functionality</name>
  <files>src/classes/netstat.class.js</files>
  <action>
Add temporary enhanced debug logging to verify the fix works, then test manually.

1. Add comprehensive debug logging at start of updateInfo():
```javascript
if (window.settings.debug) {
    console.log("[Netstat] === Interface Detection Start ===");
    console.log("[Netstat] OS:", require("os").type());
    console.log("[Netstat] Total interfaces:", data.length);
    data.forEach((iface, idx) => {
        console.log(`[Netstat] [${idx}] ${iface.iface}: operstate=${iface.operstate}, internal=${iface.internal}, ip4=${iface.ip4}, mac=${iface.mac ? iface.mac.substring(0,8)+'...' : 'none'}`);
    });
}
```

2. Ensure settings.json has debug enabled for testing:
- File: settings.json in app data directory
- Set: `"debug": true`

3. Manual test procedure (document in code comment):
```javascript
// TEST PROCEDURE:
// 1. Set debug: true in settings.json
// 2. Run: npm start (with Node 16)
// 3. Open DevTools: Ctrl+Shift+I
// 4. Check Console for:
//    - "[Netstat] Platform: Windows_NT"
//    - "[Netstat] Selected interface: {name}, ip4={address}"
// 5. Verify widget shows:
//    - STATE: ONLINE
//    - IPv4: actual IP address
//    - PING: latency in ms
// 6. Compare with Windows Task Manager network activity
  </action>
  <verify>
1. Console shows all detected interfaces with properties
2. Correct interface selected (primary network adapter)
3. Widget displays ONLINE with valid IPv4 and ping
  </verify>
  <done>
- Debug logging confirms Windows detection path
- Primary network interface selected correctly
- Widget shows ONLINE status with actual IP and ping latency
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Syntax Check:** App starts without JavaScript errors
2. **Interface Detection:** Debug console shows Windows-specific detection path
3. **Online Status:** Widget displays "ONLINE" (not "OFFLINE") when internet connected
4. **IPv4 Display:** Widget shows actual external IP address
5. **Ping Display:** Widget shows latency in milliseconds
6. **Globe Dependency:** `window.mods.netstat.offline === false` when online

Manual verification command:
```bash
# Switch to Node 16 first
nvm use 16
cd C:/Users/yzuo2/OneDrive/Desktop/yifuzuo/projects/edex-ui
npm start
```

In DevTools console, verify:
```javascript
window.mods.netstat.offline  // Should be false
window.mods.netstat.iface    // Should be interface name
window.mods.netstat.ipinfo   // Should have ip and geo properties
```
</verification>

<success_criteria>
1. Network status widget shows "ONLINE" on Windows with active internet
2. IPv4 address displayed matches system's external IP
3. Ping latency displayed (e.g., "15ms")
4. `window.mods.netstat.offline` returns `false`
5. No regression on Linux/Mac (operstate === "up" still required)
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes/01-01-SUMMARY.md`
</output>
