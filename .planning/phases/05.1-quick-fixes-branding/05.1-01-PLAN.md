---
phase: 05.1-quick-fixes-branding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/classes/netstat.class.js
  - src/classes/locationGlobe.class.js
  - src/classes/terminal.class.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Network status widget shows ONLINE when connected"
    - "Globe displays real geo coordinates (not MOCK)"
    - "File browser updates CWD when terminal directory changes"
  artifacts:
    - path: "src/classes/netstat.class.js"
      provides: "Windows network interface detection"
      contains: "isValidInterface"
    - path: "src/classes/locationGlobe.class.js"
      provides: "Globe location display with real data"
      contains: "updateLoc"
    - path: "src/classes/terminal.class.js"
      provides: "Windows CWD tracking via prompt parsing"
      contains: "_parseWindowsCwdFromOutput"
  key_links:
    - from: "src/classes/netstat.class.js"
      to: "window.mods.netstat.ipinfo"
      via: "HTTP response to myexternalip.com populates ipinfo"
      pattern: "this\\.ipinfo.*=.*ip.*geo"
    - from: "src/classes/locationGlobe.class.js"
      to: "window.mods.netstat.ipinfo.geo"
      via: "Globe reads ipinfo.geo for coordinates"
      pattern: "window\\.mods\\.netstat\\.ipinfo\\.geo"
---

<objective>
Investigate and fix remaining Phase 1 bugs: network interface detection showing offline, globe displaying mock data instead of real coordinates, and CWD tracking issues.

Purpose: Eliminate defects that degrade user experience and mask real network/location data.
Output: Working network status, globe with real geo data, and accurate CWD tracking on Windows.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-quick-fixes-branding/05.1-CONTEXT.md
@.planning/phases/05.1-quick-fixes-branding/05.1-RESEARCH.md
@src/classes/netstat.class.js
@src/classes/locationGlobe.class.js
@src/classes/terminal.class.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix network interface detection</name>
  <files>src/classes/netstat.class.js</files>
  <action>
Enable debug mode and investigate why network interface detection fails on Windows.

Current implementation (lines 103-113) accepts `operstate === "unknown"` on Windows and prioritizes by IP range. Potential issues:

1. **Check interface data completeness** - Add logging to see exact data from `window.si.networkInterfaces()`
2. **Investigate rejection path** - All interfaces may fail validation if:
   - `internal === true` for all (VPN/virtual adapters)
   - `ip4 === ""` for all (no DHCP lease)
   - `operstate` is neither "up" nor "unknown"

Debugging steps to execute:
1. Set `debug: true` in settings.json
2. Start app, open DevTools (F12), check Console for `[Netstat]` messages
3. Review logged interface data to identify which condition fails

Likely fix: If interface has valid `ip4` but fails `operstate` check, consider:
- Accept any `operstate` except "down" on Windows
- Or: If interface has valid IPv4, trust it regardless of operstate

Apply minimal fix based on debug findings. Document the root cause in code comments.
  </action>
  <verify>
Run app with `debug: true`:
1. Console shows `[Netstat] Selected interface: {name}, ip4={valid IP}`
2. Network status widget displays "ONLINE" (not "OFFLINE")
3. IPv4 field shows actual IP address (not "--.--.--.--")
  </verify>
  <done>Network status widget shows ONLINE with valid IPv4 when computer has internet connection.</done>
</task>

<task type="auto">
  <name>Task 2: Debug and fix globe mock data fallback</name>
  <files>src/classes/locationGlobe.class.js</files>
  <action>
Investigate why globe shows mock data "(MOCK)" instead of real coordinates even when online.

Current implementation (lines 172-186) checks:
1. `window.mods.netstat.offline` - shows mock if true
2. `!window.mods.netstat.ipinfo || !window.mods.netstat.ipinfo.geo` - retries in 1s if null

Potential issues:
1. **ipinfo never populated** - HTTP call to myexternalip.com fails silently
2. **geo is null** - geoLookup.get() returns null for the IP
3. **updateConOnlineConnection() throws** - Catches go to mock data

Debugging approach:
1. Add logging in `updateLoc()` to trace execution path:
   ```javascript
   if (window.settings.debug) {
       console.log("[Globe] updateLoc: offline=", window.mods.netstat.offline);
       console.log("[Globe] updateLoc: ipinfo=", window.mods.netstat.ipinfo);
   }
   ```

2. Add logging in netstat's HTTP response handler (line 177-196) to see if data arrives:
   ```javascript
   if (window.settings.debug) console.log("[Netstat] External IP response:", rawData);
   ```

3. Check geoLookup.get() result - may return null for certain IPs

Likely fixes:
- If ipinfo.geo is null but ipinfo.ip exists: geoLookup database issue - add graceful fallback showing IP without pin
- If HTTP call fails: Add retry logic or timeout handling
- If updateConOnlineConnection throws: Improve error handling to show partial data

Apply targeted fix based on debug findings.
  </action>
  <verify>
Run app with `debug: true`:
1. Console shows `[Globe] updateLoc` debug messages tracing execution
2. Console shows `[Netstat] External IP response:` with valid JSON
3. Globe header shows real coordinates (e.g., "37.7749, -122.4194") without "(MOCK)" suffix
  </verify>
  <done>Globe displays real geo coordinates from ipinfo API when computer is online.</done>
</task>

<task type="auto">
  <name>Task 3: Verify CWD tracking on Windows</name>
  <files>src/classes/terminal.class.js</files>
  <action>
Verify Windows CWD tracking works correctly with current prompt parsing implementation.

Current implementation (lines 323-345) parses:
- PowerShell: `PS C:\path\to\dir>`
- cmd.exe: `C:\path\to\dir>`
- Mid-line variants of both

Test procedure:
1. Start app with debug: true
2. Open terminal (default shell)
3. Change directory: `cd C:\Users`
4. Check if file browser updates

If CWD tracking fails, investigate:
1. **Custom prompt format** - User may have PS1/PROMPT customized
2. **Unicode in path** - Regex may fail on non-ASCII characters
3. **UNC paths** - `\\server\share` format not handled

Debugging:
1. Add logging in `_parseWindowsCwdFromOutput`:
   ```javascript
   if (window.settings.debug) {
       console.log("[Terminal] Parsing CWD from output:", data.substring(0, 200));
       console.log("[Terminal] Matched CWD:", cwd);
   }
   ```

2. Log in the Windows branch of onData handler (line 509-518)

If issue found, extend regex patterns to cover edge cases. Document findings.

If no issue found (CWD works correctly), add defensive logging and mark complete.
  </action>
  <verify>
Test CWD tracking:
1. Open PowerShell terminal in app
2. Run `cd C:\Users`
3. File browser shows `C:\Users` path
4. Run `cd C:\Windows\System32`
5. File browser shows `C:\Windows\System32` path
6. Console shows `[Terminal] Matched CWD:` debug messages
  </verify>
  <done>File browser CWD updates within 1 second when terminal directory changes on Windows.</done>
</task>

</tasks>

<verification>
All Phase 1 bug fixes verified:
1. `npm start` launches app successfully
2. Network status shows "ONLINE" with valid IPv4
3. Globe shows real coordinates (no "(MOCK)" suffix)
4. File browser updates when changing directories in terminal
5. Debug mode can be disabled (`debug: false`) and all features still work
</verification>

<success_criteria>
- Network interface detection correctly identifies active interface on Windows
- Globe displays real geo-located position from external IP lookup
- CWD tracking parses Windows prompts and updates file browser
- All fixes work without debug mode enabled
- No regressions in Linux/macOS behavior
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-quick-fixes-branding/05.1-01-SUMMARY.md`
</output>
