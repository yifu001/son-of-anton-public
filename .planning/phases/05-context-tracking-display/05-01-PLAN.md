---
phase: 05-context-tracking-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/classes/context.class.js
  - src/assets/css/mod_context.css
autonomous: true

must_haves:
  truths:
    - "User sees progress bar filling proportionally to context usage (0-100%)"
    - "User sees token count in 'Xk / Yk (Z%)' format"
    - "Progress bar color changes from green to yellow to red as usage increases"
    - "Widget shows warning state (red) when usage exceeds threshold"
    - "Widget shows placeholder ('-- / --') when no Claude session detected"
    - "Widget updates within 1 second of Claude state change"
  artifacts:
    - path: "src/classes/context.class.js"
      provides: "State subscription, token calculation, DOM rendering"
      exports: ["ContextWidget"]
    - path: "src/assets/css/mod_context.css"
      provides: "Progress bar styling with gradient, warning state, stale state"
      contains: "progress.context-progress"
  key_links:
    - from: "src/classes/context.class.js"
      to: "window.claudeState"
      via: "claude-state-changed event subscription"
      pattern: "addEventListener.*claude-state-changed"
    - from: "src/classes/context.class.js"
      to: "window.terminalSessions"
      via: "session lookup for active terminal"
      pattern: "window\\.terminalSessions\\[.*currentTerm"
    - from: "src/classes/context.class.js"
      to: "window.settings.contextWarningThreshold"
      via: "threshold configuration"
      pattern: "contextWarningThreshold.*\\|\\|.*80"
---

<objective>
Implement real-time context usage visualization in the Context widget.

Purpose: Users need to see how much of Claude's context window they've consumed to avoid hitting limits and losing conversation history.

Output:
- Working progress bar with gradient fill (green -> yellow -> red)
- Token count display in abbreviated format ("125k / 200k (62%)")
- Warning state at configurable threshold (default 80%)
- Stale data detection with dimmed display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-claude-code-state-infrastructure/04-01-SUMMARY.md
@.planning/phases/05-context-tracking-display/05-RESEARCH.md

# Current placeholder files to extend
@src/classes/context.class.js
@src/assets/css/mod_context.css

# Pattern reference for progress bar styling
@src/assets/css/mod_ramwatcher.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ContextWidget class with state subscription and rendering</name>
  <files>src/classes/context.class.js</files>
  <action>
Replace the placeholder ContextWidget class with full implementation:

1. **DOM Structure** - Update innerHTML to include:
   - Header with "CONTEXT" title and session indicator
   - `context-display` container with:
     - `context-text` span for token count ("125k / 200k (62%)")
     - `progress.context-progress` element with max="100"

2. **State Subscription** - Add in constructor:
   - Bind `_onStateChange` method
   - Subscribe to `claude-state-changed` custom event
   - Initialize from `window.claudeState` if available

3. **Token Calculation** - Add `_calculateTokens(projectData)`:
   ```javascript
   return (projectData.lastTotalInputTokens || 0) +
          (projectData.lastTotalOutputTokens || 0) +
          (projectData.lastTotalCacheCreationInputTokens || 0) +
          (projectData.lastTotalCacheReadInputTokens || 0);
   ```

4. **Number Formatting** - Add `_formatTokens(tokens)`:
   - Return `Math.floor(tokens / 1000) + 'k'` for tokens >= 1000
   - Return `String(tokens)` otherwise

5. **State Handler** - Implement `_onStateChange(event)`:
   - Get active terminal from `window.currentTerm`
   - Look up session ID from `window.terminalSessions[activeTerminal]`
   - Update session indicator text
   - If no session or no projects, call `_renderPlaceholder()`
   - Find project by matching `lastSessionId` in state.projects
   - Call `_render(projectData)` if found

6. **Render Methods**:
   - `_render(projectData)`:
     - Calculate tokens and percentage (cap at 100% with Math.min)
     - Update progress bar value
     - Update text: `${used}k / 200k (${percentage}%)`
     - Get threshold from `window.settings.contextWarningThreshold || 80`
     - Add/remove 'warning' class based on threshold
     - Remove 'stale' class on fresh data
     - Store `lastUpdate = Date.now()`
   - `_renderPlaceholder()`:
     - Set text to '-- / --'
     - Set progress value to 0
     - Remove warning class

7. **Staleness Detection** - Add `_checkStaleness()`:
   - If `Date.now() - lastUpdate > 30000`, add 'stale' class
   - Called in `_onStateChange` after render

8. **Terminal Switch Handling** - Also listen to terminal focus changes:
   - Subscribe to `window.focusShellTab` being called (wrap or use custom event)
   - Re-render when active terminal changes
   - Simple approach: check `window.currentTerm` on each state update (already in _onStateChange)

Constants:
- `maxTokens = 200000` (Claude's standard context limit)
- Staleness threshold: 30000ms (30 seconds)

Export the class via `module.exports = { ContextWidget };`
  </action>
  <verify>
1. `node -c src/classes/context.class.js` (syntax check)
2. Grep for key patterns:
   - `addEventListener.*claude-state-changed`
   - `window.terminalSessions`
   - `lastTotalInputTokens`
   - `contextWarningThreshold`
  </verify>
  <done>
- ContextWidget subscribes to claude-state-changed event
- Token calculation sums all 4 token fields from project data
- Display shows "Xk / 200k (Y%)" format
- Warning class added when percentage >= threshold
- Placeholder shown when no session detected
  </done>
</task>

<task type="auto">
  <name>Task 2: Add progress bar and state styling to mod_context.css</name>
  <files>src/assets/css/mod_context.css</files>
  <action>
Extend the existing mod_context.css with progress bar and state styles:

1. **Context Display Container**:
```css
div#mod_context .context-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5vh 0;
}
```

2. **Token Count Text**:
```css
div#mod_context .context-text {
    font-size: 1.4vh;
    color: rgba(var(--color_r), var(--color_g), var(--color_b), 1);
    margin-bottom: 0.5vh;
    text-align: center;
}
```

3. **Progress Bar Base** (following mod_ramwatcher pattern):
```css
progress.context-progress {
    -webkit-appearance: none;
    appearance: none;
    width: 90%;
    height: 0.6vh;
    border: none;
    border-right: 0.1vh solid rgba(var(--color_r), var(--color_g), var(--color_b), 0.8);
}
```

4. **Progress Bar Track**:
```css
progress.context-progress::-webkit-progress-bar {
    background: rgba(var(--color_r), var(--color_g), var(--color_b), 0.2);
    height: 0.3vh;
}
```

5. **Progress Bar Fill with Gradient**:
```css
progress.context-progress::-webkit-progress-value {
    background: linear-gradient(
        to right,
        #22c55e 0%,
        #22c55e 40%,
        #eab308 60%,
        #eab308 75%,
        #ef4444 90%,
        #ef4444 100%
    );
    height: 0.5vh;
    transition: width 0.3s ease-out;
    position: relative;
    bottom: 0.1vh;
}
```

6. **Warning State** (solid red when over threshold):
```css
div#mod_context.warning .context-text {
    color: #ef4444;
}

div#mod_context.warning progress.context-progress::-webkit-progress-value {
    background: #ef4444;
}
```

7. **Stale Data State** (dimmed):
```css
div#mod_context.stale {
    opacity: 0.5;
}
```

8. **Remove placeholder styles** (no longer needed):
- Remove `.context-placeholder` and `.context-placeholder-text` rules
- These are replaced by `.context-display` and `.context-text`
  </action>
  <verify>
1. Check CSS syntax by loading in browser dev tools
2. Grep for key patterns:
   - `progress.context-progress`
   - `linear-gradient`
   - `.warning`
   - `.stale`
  </verify>
  <done>
- Progress bar uses native element with gradient fill
- Green to yellow to red gradient matches severity
- Warning state shows solid red
- Stale state dims the widget
- Transition animates smoothly on value change
  </done>
</task>

<task type="auto">
  <name>Task 3: Add contextWarningThreshold to settings schema</name>
  <files>src/_renderer.js</files>
  <action>
Add default contextWarningThreshold to writeSettingsFile function:

1. In `window.writeSettingsFile` function, add to the settings object:
```javascript
contextWarningThreshold: Number(document.getElementById("settingsEditor-contextWarningThreshold")?.value) || 80,
```

2. In `window.openSettings` function, add a settings row in the Claude API Configuration section (after sessionLimitTokens):
```html
<tr>
    <td>contextWarningThreshold</td>
    <td>Context usage percentage to trigger warning (0-100)</td>
    <td><input type="number" id="settingsEditor-contextWarningThreshold" value="${window.settings.contextWarningThreshold || 80}" min="0" max="100"></td>
</tr>
```

This allows users to configure when the context warning triggers (default 80%).
  </action>
  <verify>
1. `node -c src/_renderer.js` (syntax check)
2. Grep for `contextWarningThreshold` in _renderer.js
3. Verify the input field appears in settings editor HTML
  </verify>
  <done>
- contextWarningThreshold setting exists in settings editor
- Default value is 80 if not set
- Value persists to settings.json when saved
  </done>
</task>

</tasks>

<verification>
1. **Syntax Check:**
   ```bash
   node -c src/classes/context.class.js
   node -c src/_renderer.js
   ```

2. **Pattern Verification:**
   ```bash
   grep -n "claude-state-changed" src/classes/context.class.js
   grep -n "terminalSessions" src/classes/context.class.js
   grep -n "contextWarningThreshold" src/classes/context.class.js src/_renderer.js
   grep -n "progress.context-progress" src/assets/css/mod_context.css
   grep -n "linear-gradient" src/assets/css/mod_context.css
   ```

3. **Visual Test (manual):**
   - Launch app with `npm start`
   - Run Claude Code in a terminal (creates ~/.claude.json)
   - Verify context widget shows token count and progress bar
   - Verify bar fills with green/yellow/red gradient
   - Verify switching terminals updates session indicator
</verification>

<success_criteria>
- [ ] Progress bar fills proportionally (0-100%)
- [ ] Token count shows "Xk / 200k (Y%)" format
- [ ] Gradient colors: green (safe) -> yellow (caution) -> red (danger)
- [ ] Warning state (red) triggers at threshold (default 80%)
- [ ] Placeholder "-- / --" when no Claude session
- [ ] Widget updates within 1 second of state change
- [ ] Settings include contextWarningThreshold option
</success_criteria>

<output>
After completion, create `.planning/phases/05-context-tracking-display/05-01-SUMMARY.md`
</output>
