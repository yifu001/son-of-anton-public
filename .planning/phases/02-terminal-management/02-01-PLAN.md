---
phase: 02-terminal-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/assets/css/main_shell.css
  - src/_renderer.js
autonomous: true

must_haves:
  truths:
    - "User can double-click terminal tab and type a custom name"
    - "Active terminal tab has visible glow effect"
    - "Custom terminal names persist across app restart"
    - "Terminal names limited to 20 characters maximum"
  artifacts:
    - path: "src/assets/css/main_shell.css"
      provides: "Active tab glow styling, contentEditable styling"
      contains: "box-shadow"
    - path: "src/_renderer.js"
      provides: "Terminal name persistence and rename UI"
      contains: "terminalNamesFile"
  key_links:
    - from: "src/_renderer.js"
      to: "terminalNames.json"
      via: "fs.writeFileSync on rename blur"
      pattern: "saveTerminalNames"
    - from: "src/_renderer.js"
      to: "ul#main_shell_tabs"
      via: "enableTabRename attaches dblclick listener"
      pattern: "dblclick.*contenteditable"
---

<objective>
Implement terminal tab management: editable names, active tab highlighting, and persistence.

Purpose: Users need to identify and customize their 5 terminal sessions. The active terminal must be visually distinct (for voice input targeting in Phase 10). Names must survive app restart.

Output:
- Enhanced active tab CSS with glow effect
- Terminal name load/save functions in _renderer.js
- Double-click-to-rename functionality on tab text
- terminalNames.json persisted in userData
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-terminal-management/02-RESEARCH.md

# Source files
@src/_renderer.js (lines 43-55, 466-664)
@src/assets/css/main_shell.css (lines 45-93)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add active tab glow styling</name>
  <files>src/assets/css/main_shell.css</files>
  <action>
Add glow effect to the active terminal tab to indicate "receives voice input" state.

Modify `ul#main_shell_tabs > li.active` rule (around line 87-93):
1. Change `z-index: -1` to `z-index: 1` (glow must be visible above siblings)
2. Add box-shadow for glow effect using theme colors:
   ```css
   box-shadow:
       0 0 8px rgba(var(--color_r), var(--color_g), var(--color_b), 0.8),
       0 0 16px rgba(var(--color_r), var(--color_g), var(--color_b), 0.4);
   ```
3. Add subtle pulsing animation for "active input" feel:
   ```css
   animation: activeGlow 2s ease-in-out infinite alternate;
   ```
4. Define `@keyframes activeGlow` animation (0%: opacity 0.6, 100%: opacity 0.9)

Also add styling for contentEditable state (for Task 3):
```css
ul#main_shell_tabs > li p[contenteditable="true"] {
    background: rgba(0, 0, 0, 0.5);
    outline: 1px solid rgb(var(--color_r), var(--color_g), var(--color_b));
    padding: 2px 4px;
    min-width: 50px;
}
```
  </action>
  <verify>
Open app, verify:
1. Active tab has visible glow effect
2. Glow uses theme color (changes with theme)
3. Glow animates subtly
  </verify>
  <done>Active terminal tab has distinct visual indicator (glow + animation)</done>
</task>

<task type="auto">
  <name>Task 2: Implement terminal name persistence</name>
  <files>src/_renderer.js</files>
  <action>
Add terminal name persistence using the same pattern as settings.json.

1. After line 49 (shortcutsFile declaration), add:
   ```javascript
   const terminalNamesFile = path.join(settingsDir, "terminalNames.json");
   ```

2. After line 54 (lastWindowState loading), add load logic with defaults:
   ```javascript
   // Load terminal names with fallback to defaults
   try {
       if (fs.existsSync(terminalNamesFile)) {
           window.terminalNames = JSON.parse(fs.readFileSync(terminalNamesFile, 'utf-8'));
       } else {
           window.terminalNames = { 0: "MAIN SHELL", 1: "EMPTY", 2: "EMPTY", 3: "EMPTY", 4: "EMPTY" };
       }
   } catch (e) {
       console.error("Failed to load terminal names:", e);
       window.terminalNames = { 0: "MAIN SHELL", 1: "EMPTY", 2: "EMPTY", 3: "EMPTY", 4: "EMPTY" };
   }
   ```

3. Add save function (place after the loading code):
   ```javascript
   window.saveTerminalNames = () => {
       try {
           fs.writeFileSync(terminalNamesFile, JSON.stringify(window.terminalNames, null, 4));
       } catch (e) {
           console.error("Failed to save terminal names:", e);
       }
   };
   ```

4. Modify tab initialization (lines 467-474) to use saved names:
   Replace hardcoded tab names with:
   ```javascript
   shellContainer.innerHTML += `
       <ul id="main_shell_tabs">
           <li id="shell_tab0" onclick="window.focusShellTab(0);" class="active"><p>${window._escapeHtml(window.terminalNames[0])}</p></li>
           <li id="shell_tab1" onclick="window.focusShellTab(1);"><p>${window._escapeHtml(window.terminalNames[1])}</p></li>
           <li id="shell_tab2" onclick="window.focusShellTab(2);"><p>${window._escapeHtml(window.terminalNames[2])}</p></li>
           <li id="shell_tab3" onclick="window.focusShellTab(3);"><p>${window._escapeHtml(window.terminalNames[3])}</p></li>
           <li id="shell_tab4" onclick="window.focusShellTab(4);"><p>${window._escapeHtml(window.terminalNames[4])}</p></li>
       </ul>
       ...`;
   ```

5. Modify onprocesschange handlers to respect custom names:
   - Line 490-492 (main shell): Only update if name is default "MAIN SHELL"
   - Line 653-655 (spawned tabs): Only update if name matches default pattern

   Pattern:
   ```javascript
   window.term[0].onprocesschange = p => {
       // Only show process name if user hasn't set a custom name
       if (window.terminalNames[0] === "MAIN SHELL") {
           document.getElementById("shell_tab0").querySelector('p').innerHTML = `MAIN - ${p}`;
       }
   };
   ```

   For spawned tabs (number >= 1):
   ```javascript
   window.term[number].onprocesschange = p => {
       // Only show process name if user hasn't set a custom name
       const defaultName = `#${number + 1}`;
       if (window.terminalNames[number] === "EMPTY" || window.terminalNames[number].startsWith('#')) {
           document.getElementById("shell_tab" + number).querySelector('p').innerHTML = `#${number + 1} - ${p}`;
       }
   };
   ```
  </action>
  <verify>
1. Start app fresh (delete terminalNames.json if exists)
2. Verify tabs show default names ("MAIN SHELL", "EMPTY", ...)
3. Check terminalNames.json is NOT created yet (only on first rename)
4. Verify onprocesschange still shows process name for default-named tabs
  </verify>
  <done>Terminal names load from file on startup, fall back to defaults if missing</done>
</task>

<task type="auto">
  <name>Task 3: Implement click-to-rename UI</name>
  <files>src/_renderer.js</files>
  <action>
Add double-click-to-rename functionality for terminal tabs.

1. Create enableTabRename function (add after saveTerminalNames):
   ```javascript
   window.enableTabRename = (tabIndex) => {
       const tabElement = document.getElementById(`shell_tab${tabIndex}`);
       const textElement = tabElement.querySelector('p');

       textElement.addEventListener('dblclick', (e) => {
           e.stopPropagation(); // Prevent tab switch
           textElement.setAttribute('contenteditable', 'true');
           textElement.focus();
           // Select all text for easy replacement
           const range = document.createRange();
           range.selectNodeContents(textElement);
           window.getSelection().removeAllRanges();
           window.getSelection().addRange(range);
       });

       textElement.addEventListener('blur', () => {
           textElement.removeAttribute('contenteditable');
           let newName = textElement.innerText.trim().substring(0, 20); // Max 20 chars
           if (!newName) newName = tabIndex === 0 ? "MAIN SHELL" : "EMPTY";
           window.terminalNames[tabIndex] = newName;
           textElement.innerHTML = window._escapeHtml(newName);
           window.saveTerminalNames();
       });

       textElement.addEventListener('keydown', (e) => {
           if (e.key === 'Enter') {
               e.preventDefault();
               textElement.blur(); // Triggers save via blur handler
           } else if (e.key === 'Escape') {
               // Revert to saved name
               textElement.innerText = window.terminalNames[tabIndex];
               textElement.blur();
           }
       });
   };
   ```

2. Call enableTabRename for each tab after tab initialization (after the shellContainer.innerHTML block, around line 481):
   ```javascript
   // Enable rename on all tabs
   for (let i = 0; i < 5; i++) {
       window.enableTabRename(i);
   }
   ```

3. For newly spawned terminals (in focusShellTab, around line 657), also enable rename:
   After `document.getElementById("shell_tab" + number).innerHTML = ...`:
   ```javascript
   window.enableTabRename(number);
   ```

Note: The onclick for tab switching uses single click. Double-click triggers rename. This separation is intentional per research findings.
  </action>
  <verify>
1. Start app
2. Double-click "MAIN SHELL" tab text - verify it becomes editable with text selected
3. Type "Claude 1" and press Enter - verify name updates
4. Press Ctrl+Shift+R to reload - verify "Claude 1" persists
5. Double-click, type very long name (30+ chars), blur - verify truncated to 20 chars
6. Double-click, clear all text, blur - verify reverts to default name
7. Double-click, press Escape - verify reverts to previous name without saving
8. Single-click different tab - verify switches tab (not editing)
  </verify>
  <done>User can double-click terminal tab to edit name (max 20 chars), saves on Enter/blur, Escape reverts</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm start` launches app successfully
2. Active tab has visible glow effect
3. Can double-click any tab to rename
4. Names persist in `%APPDATA%/Son of Anton/terminalNames.json`
5. App restart preserves custom names
6. Names truncate at 20 characters
7. Process name updates only affect default-named tabs
</verification>

<success_criteria>
- TERM-01: Double-click tab text to rename, Enter/blur saves, max 20 chars
- TERM-02: Active tab has box-shadow glow with theme color
- TERM-03: terminalNames.json in userData persists across restart
- No regressions: tab switching, process name display on defaults still work
</success_criteria>

<output>
After completion, create `.planning/phases/02-terminal-management/02-01-SUMMARY.md`
</output>
