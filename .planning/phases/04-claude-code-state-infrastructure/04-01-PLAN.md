---
phase: 04-claude-code-state-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/classes/claudeState.class.js
  - src/_boot.js
  - src/_renderer.js
autonomous: true

must_haves:
  truths:
    - "ClaudeStateManager watches ~/.claude.json for changes"
    - "ClaudeStateManager watches ~/.claude/todos/ directory for todo files"
    - "Renderer receives state updates via IPC channel claude-state-update"
    - "Each terminal can be mapped to a Claude session via CWD"
    - "JSON parse failures are logged but do not crash the app"
  artifacts:
    - path: "src/classes/claudeState.class.js"
      provides: "ClaudeStateManager singleton class"
      min_lines: 100
      exports: ["ClaudeStateManager"]
    - path: "src/_boot.js"
      provides: "ClaudeStateManager initialization and cleanup"
      contains: "ClaudeStateManager"
    - path: "src/_renderer.js"
      provides: "IPC listener for claude-state-update"
      contains: "claude-state-update"
  key_links:
    - from: "src/_boot.js"
      to: "src/classes/claudeState.class.js"
      via: "require and instantiation"
      pattern: "require.*claudeState\\.class"
    - from: "src/classes/claudeState.class.js"
      to: "mainWindow.webContents.send"
      via: "IPC send to renderer"
      pattern: "webContents\\.send.*claude-state-update"
    - from: "src/_renderer.js"
      to: "window.term"
      via: "maps terminal CWD to session"
      pattern: "ipc\\.on.*claude-state-update"
---

<objective>
Establish file watching infrastructure for Claude Code session state.

Purpose: Enable the app to track Claude Code session data (projects, todos) in real-time by watching `~/.claude.json` and `~/.claude/todos/` directory. This infrastructure is the foundation for all Claude visibility features (context, agents, todos).

Output:
- ClaudeStateManager class with chokidar file watchers
- IPC pipeline sending state updates to renderer
- Terminal-to-session mapping based on CWD
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-claude-code-state-infrastructure/04-RESEARCH.md

# Key source files
@src/_boot.js
@src/_renderer.js
@src/classes/terminal.class.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClaudeStateManager class</name>
  <files>src/classes/claudeState.class.js</files>
  <action>
Create ClaudeStateManager class in src/classes/claudeState.class.js with:

1. **Constructor (mainWindow parameter):**
   - Store mainWindow reference
   - Initialize paths: claudeDir = path.join(os.homedir(), '.claude'), claudeJsonPath = path.join(os.homedir(), '.claude.json'), todosDir = path.join(claudeDir, 'todos')
   - Initialize state object: { projects: {}, todos: {}, lastUpdate: null }
   - Initialize watchers array and debounce timeout

2. **start() method:**
   - Watch claudeJsonPath with chokidar using options:
     ```javascript
     {
       persistent: true,
       ignoreInitial: false,
       awaitWriteFinish: { stabilityThreshold: 500, pollInterval: 100 },
       ignorePermissionErrors: true
     }
     ```
   - Watch todosDir with same options plus `depth: 0`
   - Bind event handlers: 'add', 'change' -> parse file; 'unlink' -> remove from state; 'error' -> log only
   - Store watchers in array for cleanup

3. **stop() method:**
   - Call close() on all watchers
   - Clear watchers array

4. **_safeParseJson(filepath, fallback) method:**
   - Check file exists with fs.existsSync
   - Read file content with fs.readFileSync
   - Try JSON.parse in try-catch
   - Log parse errors with console.error (not throw)
   - Return fallback value on any error

5. **_handleMainStateChange(filepath) method:**
   - Parse file with _safeParseJson(filepath, {})
   - If data.projects exists, update state.projects
   - Call _sendUpdate()

6. **_handleTodoChange(filepath) method:**
   - Skip if filename doesn't end with '.json'
   - Parse with _safeParseJson(filepath, [])
   - Extract sessionId from filename: filename.split('-agent-')[0]
   - Store in state.todos[sessionId]
   - Call _sendUpdate()

7. **_handleTodoRemove(filepath) method:**
   - Extract sessionId from filename
   - Delete from state.todos
   - Call _sendUpdate()

8. **_sendUpdate() method (with 100ms debounce):**
   - Clear existing timeout if any
   - Set new timeout that:
     - Checks mainWindow exists and !isDestroyed()
     - Sends IPC 'claude-state-update' with state object

9. **getSessionForProject(projectPath) method:**
   - Normalize projectPath (replace backslashes with forward slashes, lowercase)
   - Iterate state.projects to find matching path prefix
   - Return lastSessionId if found, null otherwise

Use chokidar@3.5.3 (already specified in research). Follow existing class patterns in codebase (constructor-based, module.exports = ClassName).
  </action>
  <verify>
   - File exists at src/classes/claudeState.class.js
   - Class exports correctly: `node -e "const C = require('./src/classes/claudeState.class.js'); console.log(typeof C);"` outputs "function"
   - No syntax errors: `node --check src/classes/claudeState.class.js`
  </verify>
  <done>
   - ClaudeStateManager class created with all methods
   - chokidar watches configured with awaitWriteFinish
   - JSON parsing wrapped in try-catch with fallback
   - IPC send implemented with debounce
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ClaudeStateManager into _boot.js</name>
  <files>src/_boot.js</files>
  <action>
Modify src/_boot.js to initialize and manage ClaudeStateManager:

1. **Add require at top (after existing requires):**
   ```javascript
   const ClaudeStateManager = require("./classes/claudeState.class.js");
   ```

2. **Add variable declaration (after `var win, tty, extraTtys;`):**
   ```javascript
   var claudeStateManager = null;
   ```

3. **Initialize after window load in createWindow() function:**
   After the existing `win.show()` block, add:
   ```javascript
   // Initialize Claude state manager after window is ready
   win.webContents.on('did-finish-load', () => {
       claudeStateManager = new ClaudeStateManager(win);
       claudeStateManager.start();
       signale.success("Claude state manager initialized");
   });
   ```

4. **Add cleanup in 'before-quit' handler:**
   In the existing `app.on('before-quit', ...)` handler, add before the final signale.complete:
   ```javascript
   if (claudeStateManager) {
       claudeStateManager.stop();
   }
   ```

Do NOT modify any other existing code in _boot.js. Insert new code at appropriate locations preserving existing structure.
  </action>
  <verify>
   - No syntax errors: `node --check src/_boot.js`
   - ClaudeStateManager required: grep for "claudeState.class" in _boot.js
   - Initialization present: grep for "did-finish-load" and "ClaudeStateManager" in _boot.js
   - Cleanup present: grep for "claudeStateManager.stop" in _boot.js
  </verify>
  <done>
   - ClaudeStateManager imported in _boot.js
   - Initialized after window did-finish-load event
   - Cleanup on before-quit event
  </done>
</task>

<task type="auto">
  <name>Task 3: Add IPC listener in _renderer.js</name>
  <files>src/_renderer.js</files>
  <action>
Add IPC listener and terminal-session mapping to src/_renderer.js:

1. **Add terminal session tracking variables (after window.terminalNames loading, around line 68):**
   ```javascript
   // Claude state tracking - maps terminal index to Claude session ID
   window.terminalSessions = {};  // { terminalIndex: sessionId }
   window.claudeState = null;     // Latest state from main process
   ```

2. **Add IPC listener (after the existing ipc.send("getKbOverride") block, around line 143):**
   ```javascript
   // Claude state updates from main process
   ipc.on('claude-state-update', (event, state) => {
       window.claudeState = state;

       // Map each active terminal to a Claude session based on CWD
       for (let i = 0; i < 5; i++) {
           if (window.term && window.term[i] && window.term[i].cwd) {
               const sessionId = findSessionForCwd(window.term[i].cwd, state.projects);
               if (sessionId) {
                   window.terminalSessions[i] = sessionId;
               } else {
                   delete window.terminalSessions[i];
               }
           }
       }

       // Emit custom event for widgets to listen to (future phases)
       window.dispatchEvent(new CustomEvent('claude-state-changed', { detail: state }));
   });

   // Helper: Find Claude session ID for a given CWD
   function findSessionForCwd(cwd, projects) {
       if (!cwd || !projects) return null;

       const normalizedCwd = cwd.replace(/\\/g, '/').toLowerCase();
       let bestMatch = null;
       let bestMatchLen = 0;

       for (const [projPath, projData] of Object.entries(projects)) {
           const normalizedProj = projPath.replace(/\\/g, '/').toLowerCase();
           if (normalizedCwd.startsWith(normalizedProj) &&
               normalizedProj.length > bestMatchLen &&
               projData.lastSessionId) {
               bestMatch = projData.lastSessionId;
               bestMatchLen = normalizedProj.length;
           }
       }

       return bestMatch;
   }
   ```

This places window.terminalSessions, window.claudeState, and the IPC listener in global scope so widgets (Phase 5+) can access them. The findSessionForCwd helper matches terminal CWD to Claude project paths using longest-prefix matching with path normalization for Windows compatibility.
  </action>
  <verify>
   - No syntax errors: open app or run `node -e "require('./src/_renderer.js')"` (will fail due to electron but syntax checked)
   - IPC listener present: grep for "claude-state-update" in _renderer.js
   - Session mapping function present: grep for "findSessionForCwd" in _renderer.js
   - Terminal sessions tracking: grep for "terminalSessions" in _renderer.js
  </verify>
  <done>
   - IPC listener registered for 'claude-state-update'
   - Terminal-to-session mapping implemented with path normalization
   - Custom event emitted for future widget consumption
   - window.claudeState and window.terminalSessions available globally
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax check all modified files:**
   ```bash
   node --check src/classes/claudeState.class.js
   node --check src/_boot.js
   ```

2. **Verify chokidar dependency:**
   ```bash
   cd src && npm ls chokidar
   ```
   If not installed: `cd src && npm install chokidar@3.5.3`

3. **Manual integration test (if app can be started):**
   - Start the app
   - Check console for "Claude state manager initialized"
   - If ~/.claude.json exists, verify no errors in console
   - Close app and verify clean shutdown (no crash)

4. **Code review checklist:**
   - [ ] ClaudeStateManager has start() and stop() methods
   - [ ] awaitWriteFinish configured with stabilityThreshold: 500
   - [ ] JSON parsing wrapped in try-catch
   - [ ] IPC send checks window.isDestroyed()
   - [ ] Path normalization handles Windows backslashes
   - [ ] Cleanup in before-quit handler
</verification>

<success_criteria>
- ClaudeStateManager class exists and exports correctly
- File watchers configured with awaitWriteFinish for Windows race conditions
- IPC channel 'claude-state-update' implemented
- Terminal sessions can be mapped to Claude sessions via CWD
- Parse failures logged but app does not crash
- Clean startup and shutdown with proper watcher cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/04-claude-code-state-infrastructure/04-01-SUMMARY.md`
</output>
