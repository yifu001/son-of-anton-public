---
phase: 08-silent-failures-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/classes/claudeState.class.js
  - src/_renderer.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Polling errors in ClaudeStateManager are logged with [ClaudeState] prefix"
    - "Directory scan errors in ClaudeStateManager are logged with [ClaudeState] prefix"
    - "IPC systeminformation calls reject after 30s timeout instead of hanging forever"
    - "File write operations show error message when write fails"
    - "Success messages only appear after confirmed successful operations"
  artifacts:
    - path: "src/classes/claudeState.class.js"
      provides: "Error logging in all catch blocks"
      contains: "console.warn.*ClaudeState"
    - path: "src/_renderer.js"
      provides: "IPC timeout, file write error handling"
      contains: "setTimeout.*30000"
  key_links:
    - from: "claudeState.class.js catch blocks"
      to: "console.warn"
      via: "unconditional logging with prefix"
      pattern: "console\\.warn.*\\[ClaudeState\\]"
    - from: "_renderer.js IPC Promise"
      to: "reject"
      via: "setTimeout timeout"
      pattern: "setTimeout.*reject.*30000"
---

<objective>
Fix all 12 silent failure patterns across claudeState.class.js and _renderer.js.

Purpose: Enable debugging by surfacing errors that are currently swallowed, preventing indefinite IPC hangs, and showing users actual file operation failures instead of false success messages.

Output: Modified source files with debug-gated logging, IPC timeout, and proper file write error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-silent-failures-fix/08.1-RESEARCH.md
@src/classes/claudeState.class.js
@src/_renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add debug-gated logging to ClaudeStateManager catch blocks</name>
  <files>src/classes/claudeState.class.js</files>
  <action>
Add logging to all 7 empty catch blocks in claudeState.class.js. Use `console.warn` for expected/recoverable errors, `[ClaudeState]` prefix.

**Note:** ClaudeStateManager runs in main process (Node.js), not renderer. Must check for `global.debugMode` OR pass debug flag from renderer. For now, use process.env.DEBUG or a simple console.warn without gating (main process logs are visible in terminal, not DevTools).

**Alternative approach for main process:** Use unconditional `console.warn` with `[ClaudeState]` prefix since main process logs don't clutter DevTools and are useful for debugging.

Locations to fix:

1. **Lines 122-124** (`_pollLiveContext`):
```javascript
} catch (error) {
    console.warn("[ClaudeState] Live context poll failed:", error.message);
}
```

2. **Lines 288-290** (`_scanAllAgents` - subdir scan):
```javascript
} catch (e) {
    console.warn("[ClaudeState] Error scanning subdir:", subdirPath, e.message);
}
```

3. **Lines 292-294** (`_scanAllAgents` - project scan):
```javascript
} catch (e) {
    console.warn("[ClaudeState] Error scanning project:", project, e.message);
}
```

4. **Lines 365-367** (`_scanSubagentsDir` - agent parse):
```javascript
} catch (e) {
    console.warn("[ClaudeState] Error parsing agent file:", filepath, e.message);
}
```

5. **Lines 379-381** (`_scanSubagentsDir` - individual file):
```javascript
} catch (e) {
    console.warn("[ClaudeState] Error processing agent file:", file, e.message);
}
```

6. **Lines 383-385** (`_scanSubagentsDir` - directory read):
```javascript
} catch (error) {
    console.warn("[ClaudeState] Error reading subagents directory:", subagentsDir, error.message);
}
```

7. **Lines 416-418** (`_getAgentStatus` - todo lookup):
```javascript
} catch (e) {
    console.warn("[ClaudeState] Error reading todo file for agent status:", todoPath, e.message);
}
```

**DO NOT modify:**
- `_handleError` method (already logs properly)
- `_safeParseJson` method (already logs with console.error)
  </action>
  <verify>
1. Run `grep -n "console.warn.*ClaudeState" src/classes/claudeState.class.js` - should show 7 lines
2. Run `grep -n "// Ignore" src/classes/claudeState.class.js` - should return 0 lines (all comments replaced)
  </verify>
  <done>All 7 empty catch blocks in claudeState.class.js now log errors with [ClaudeState] prefix</done>
</task>

<task type="auto">
  <name>Task 2: Add IPC timeout and username fetch logging in _renderer.js</name>
  <files>src/_renderer.js</files>
  <action>
Fix 2 issues in _renderer.js:

**Issue 1: IPC Promise never rejects (lines 302-311)**

Replace the systeminformation proxy Promise with timeout handling:

```javascript
return new Promise((resolve, reject) => {
    let id = nanoid();
    let timeoutId = null;

    const handler = (e, res) => {
        clearTimeout(timeoutId);
        if (callback) {
            args[args.length - 1](res);
        }
        resolve(res);
    };

    ipc.once("systeminformation-reply-" + id, handler);
    ipc.send("systeminformation-call", prop, id, ...args);

    // 30 second timeout to prevent indefinite hangs
    timeoutId = setTimeout(() => {
        ipc.removeListener("systeminformation-reply-" + id, handler);
        const error = new Error(`IPC timeout: systeminformation.${prop}() did not respond within 30s`);
        if (window.settings && window.settings.debug) {
            console.error("[Renderer] " + error.message);
        }
        reject(error);
    }, 30000);
});
```

**Issue 2: Username fetch silent catch (line 452)**

Add debug logging:
```javascript
try {
    user = await require("username")();
} catch (e) {
    if (window.settings && window.settings.debug) {
        console.warn("[Renderer] Username fetch failed:", e.message);
    }
}
```
  </action>
  <verify>
1. Run `grep -n "setTimeout.*30000" src/_renderer.js` - should show 1 line in initSystemInformationProxy
2. Run `grep -n "removeListener.*systeminformation" src/_renderer.js` - should show 1 line (timeout cleanup)
3. Run `grep -n "Username fetch failed" src/_renderer.js` - should show 1 line
  </verify>
  <done>IPC Promise has 30s timeout with proper listener cleanup; username fetch logs errors in debug mode</done>
</task>

<task type="auto">
  <name>Task 3: Fix file write error handling in _renderer.js</name>
  <files>src/_renderer.js</files>
  <action>
Fix 3 file write operations that ignore errors:

**Issue 1: writeFile function (lines 1040-1044)**

Replace:
```javascript
window.writeFile = (path) => {
    fs.writeFile(path, document.getElementById("fileEdit").value, "utf-8", () => {
        document.getElementById("fedit-status").innerHTML = "<i>File saved.</i>";
    });
};
```

With:
```javascript
window.writeFile = (filePath) => {
    fs.writeFile(filePath, document.getElementById("fileEdit").value, "utf-8", (err) => {
        if (err) {
            document.getElementById("fedit-status").innerHTML = `<i style="color: var(--color_red);">Save failed: ${window._escapeHtml(err.message)}</i>`;
            if (window.settings && window.settings.debug) {
                console.error("[Renderer] File write failed:", filePath, err.message);
            }
            return;
        }
        document.getElementById("fedit-status").innerHTML = "<i>File saved.</i>";
    });
};
```

Note: Renamed parameter from `path` to `filePath` to avoid shadowing the `path` module.

**Issue 2: writeSettingsFile (line 1086)**

Wrap in try-catch:
```javascript
try {
    fs.writeFileSync(settingsFile, JSON.stringify(window.settings, "", 4));
    document.getElementById("settingsEditorStatus").innerText = "New values written to settings.json file at " + new Date().toTimeString();
} catch (err) {
    document.getElementById("settingsEditorStatus").innerText = "Save failed: " + err.message;
    if (window.settings && window.settings.debug) {
        console.error("[Renderer] Settings write failed:", err.message);
    }
}
```

**Issue 3: toggleFullScreen lastWindowState save (line 1097)**

Wrap in try-catch with debug logging:
```javascript
try {
    fs.writeFileSync(lastWindowStateFile, JSON.stringify(window.lastWindowState, "", 4));
} catch (err) {
    if (window.settings && window.settings.debug) {
        console.error("[Renderer] Window state save failed:", err.message);
    }
}
```
  </action>
  <verify>
1. Run `grep -n "Save failed" src/_renderer.js` - should show 2 lines (writeFile and writeSettingsFile)
2. Run `grep -n "color: var(--color_red)" src/_renderer.js` - should show 1 line (writeFile error styling)
3. Run `grep -n "Window state save failed" src/_renderer.js` - should show 1 line
4. Run `grep -n "Settings write failed" src/_renderer.js` - should show 1 line
  </verify>
  <done>All 3 file write operations properly handle errors and show appropriate messages to users</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **No silent failures remain:**
   ```bash
   grep -n "// Ignore" src/classes/claudeState.class.js src/_renderer.js
   # Should return empty (no "Ignore" comments in catch blocks)
   ```

2. **Debug logging added:**
   ```bash
   grep -c "console.warn.*ClaudeState" src/classes/claudeState.class.js
   # Should return 7

   grep -c "console.warn.*Renderer\|console.error.*Renderer" src/_renderer.js
   # Should return 5 (username, IPC timeout, writeFile, writeSettings, toggleFullScreen)
   ```

3. **IPC timeout present:**
   ```bash
   grep -n "30000" src/_renderer.js
   # Should show timeout in initSystemInformationProxy
   ```

4. **Error handling in file writes:**
   ```bash
   grep -A2 "fs.writeFile\|fs.writeFileSync" src/_renderer.js | grep -c "err\|catch"
   # Should return 3 (one for each write operation)
   ```
</verification>

<success_criteria>
1. All 7 empty catch blocks in claudeState.class.js log errors with [ClaudeState] prefix
2. IPC Promise in _renderer.js rejects after 30s with meaningful error message
3. fs.writeFile in writeFile() checks error and shows red error message on failure
4. fs.writeFileSync in writeSettingsFile() wrapped in try-catch, shows error in status
5. fs.writeFileSync in toggleFullScreen() wrapped in try-catch with debug logging
6. Username fetch failure logged in debug mode
7. No "// Ignore" comments remain in catch blocks (replaced with actual handling)
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-silent-failures-fix/08.1-01-SUMMARY.md`
</output>
